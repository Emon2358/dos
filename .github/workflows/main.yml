name: Create IMG in Workflow, Build, and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. è‡ªåˆ†ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout your repository
        uses: actions/checkout@v4

      # 2. DOSBox-Xã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout DOSBox-X source code
        uses: actions/checkout@v4
        with:
          repository: joncampbell123/dosbox-x
          path: dosbox-x-src
          ref: v2024.03.01

      # 3. Emscripten (emsdk)ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v12
        with:
          version: '3.1.55'

      # 4. ãƒ‡ã‚£ã‚¹ã‚¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ or æ–°è¦ä½œæˆï¼†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ğŸš€
      - name: Cache disk images
        id: cache-disks
        uses: actions/cache@v4
        with:
          path: generated-disks # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          key: ${{ runner.os }}-disks-win95-v2 # ã‚­ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½œã‚Šç›´ã•ã‚Œã¾ã™

      - name: Create/Download disk images if not cached
        if: steps.cache-disks.outputs.cache-hit != 'true'
        run: |
          mkdir -p generated-disks
          echo "Cache not found. Creating a new 2GB disk image..."
          # â–¼â–¼â–¼ ã“ã“ã§2GBã®ç©ºã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ â–¼â–¼â–¼
          dd if=/dev/zero of=generated-disks/win95.img bs=1M count=2048
          
          echo "Downloading win95.iso from Releases..."
          # â–¼â–¼â–¼ ã‚ãªãŸã®GitHub Releaseã®ISO URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
          curl -L -o generated-disks/win95.iso "https://github.com/Emon2358/dos/releases/download/win95/win95.iso"
          # â–²â–²â–² ã‚ãªãŸã®GitHub Releaseã®ISO URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â–²â–²â–²

      # 5. ãƒ“ãƒ«ãƒ‰ã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y automake libtool-bin

      # 6. DOSBox-Xã®ãƒ“ãƒ«ãƒ‰
      - name: Build DOSBox-X with Emscripten
        run: |
          cd dosbox-x-src
          ./autogen.sh
          emconfigure ./configure \
            --host=wasm32-unknown-emscripten --with-sdl2 --enable-static --disable-shared \
            --disable-avcodec --disable-opengl --disable-network --disable-printer --disable-slirp
          emmake make -j$(nproc)
          cd ..

      # 7. GitHub Pagesç”¨ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’æº–å‚™
      - name: Prepare artifact for GitHub Pages
        run: |
          mkdir _site
          cp dosbox-x-src/src/dosbox-x.html _site/index.html
          cp dosbox-x-src/src/dosbox-x.js _site/
          cp dosbox-x-src/src/dosbox-x.wasm _site/
          # ä½œæˆ/å¾©å…ƒã—ãŸãƒ‡ã‚£ã‚¹ã‚¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼
          mkdir _site/disks
          cp generated-disks/win95.img _site/disks/
          cp generated-disks/win95.iso _site/disks/
          # dosbox.confã‚’è‡ªå‹•ç”Ÿæˆ
          echo "[autoexec]
          mount c disks
          imgmount d disks/win95.iso -t iso
          boot c:
          " > _site/dosbox.conf

      # 8. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      # 9. GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
